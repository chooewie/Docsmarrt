<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DocSmart - T√≥m T·∫Øt T√†i Li·ªáu Th√¥ng Minh</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --primary:#4F8EF7;--primary-dark:#3a72d4;--secondary:#7C5CBF;
  --accent:#F7A84F;--bg:#F5F7FA;--white:#fff;--gray:#6b7280;
  --light:#e8edf5;--border:#dde3ee;--text:#1e2a3a;
  --shadow:0 4px 24px rgba(79,142,247,.12);
}
body{font-family:'Segoe UI',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}

/* HEADER */
header{background:var(--white);box-shadow:0 2px 12px rgba(0,0,0,.07);padding:0 32px;display:flex;align-items:center;justify-content:space-between;height:60px;position:sticky;top:0;z-index:100}
.logo{font-size:1.5rem;font-weight:800;color:var(--primary)}.logo span{color:var(--secondary)}
.header-btns{display:flex;gap:10px}
.btn{padding:8px 18px;border-radius:8px;border:none;cursor:pointer;font-size:.9rem;font-weight:600;transition:all .2s}
.btn-outline{background:transparent;border:2px solid var(--primary);color:var(--primary)}
.btn-outline:hover{background:var(--primary);color:#fff}
.btn-primary{background:var(--primary);color:#fff}
.btn-primary:hover{background:var(--primary-dark)}
.btn-sm{padding:6px 13px;font-size:.82rem}

/* HERO */
.hero{text-align:center;padding:48px 20px 32px;background:linear-gradient(135deg,#eef3ff 0%,#f5f0ff 100%)}
.hero h1{font-size:2.2rem;font-weight:800;color:var(--text);margin-bottom:10px}
.hero h1 span{color:var(--primary)}
.hero p{color:var(--gray);font-size:1.05rem;max-width:560px;margin:0 auto 24px}

/* CONTAINER */
.container{max-width:1100px;margin:0 auto;padding:28px 20px}

/* UPLOAD */
.upload-section{background:var(--white);border-radius:16px;box-shadow:var(--shadow);padding:28px}
.upload-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px}
@media(max-width:600px){.upload-grid{grid-template-columns:1fr}}
.upload-card{border:2px dashed var(--border);border-radius:12px;padding:24px;text-align:center;cursor:pointer;transition:all .2s;position:relative;overflow:hidden}
.upload-card:hover,.upload-card.dragover{border-color:var(--primary);background:#f0f5ff}
.upload-card input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.upload-icon{font-size:2.2rem;margin-bottom:8px}
.upload-card h3{font-size:.95rem;font-weight:700;margin-bottom:4px}
.upload-card p{font-size:.8rem;color:var(--gray)}
.yt-row{display:flex;gap:10px;margin-bottom:16px}
.yt-row input{flex:1;padding:10px 14px;border-radius:8px;border:1.5px solid var(--border);font-size:.9rem;outline:none;transition:border .2s}
.yt-row input:focus{border-color:var(--primary)}
.text-area-wrap{position:relative;margin-bottom:16px}
.text-area-wrap textarea{width:100%;height:110px;padding:12px;border-radius:8px;border:1.5px solid var(--border);font-size:.9rem;resize:vertical;outline:none;transition:border .2s;font-family:inherit}
.text-area-wrap textarea:focus{border-color:var(--primary)}
.char-count{position:absolute;bottom:8px;right:12px;font-size:.75rem;color:var(--gray)}

/* FILE LIST */
.file-list{margin:12px 0}
.file-item{display:flex;align-items:center;gap:10px;background:var(--light);border-radius:8px;padding:8px 12px;margin-bottom:6px}
.file-item .fname{flex:1;font-size:.85rem;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.file-item .fremove{background:none;border:none;color:#ef4444;cursor:pointer;font-size:1.1rem}

/* ANALYZE BTN */
.analyze-btn{width:100%;padding:14px;background:linear-gradient(90deg,var(--primary),var(--secondary));color:#fff;border:none;border-radius:12px;font-size:1.05rem;font-weight:700;cursor:pointer;transition:opacity .2s;margin-top:8px}
.analyze-btn:hover{opacity:.9}
.analyze-btn:disabled{opacity:.5;cursor:not-allowed}

/* LOADING */
.loading{display:none;flex-direction:column;align-items:center;padding:48px;gap:14px}
.spinner{width:48px;height:48px;border:5px solid var(--light);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading p{color:var(--gray);font-weight:600}
.loading-steps{display:flex;flex-direction:column;gap:6px;margin-top:8px;width:100%;max-width:300px}
.loading-step{font-size:.82rem;color:#aaa;padding:4px 12px;border-radius:20px;background:var(--light);transition:all .4s}
.loading-step.active{color:var(--primary);background:#e8f0ff;font-weight:700}
.loading-step.done{color:#34d399;background:#e8fff5}

/* RESULT */
.result-section{display:none}
.result-tabs{display:flex;gap:6px;margin-bottom:16px}
.rtab{padding:9px 18px;border-radius:8px;border:2px solid var(--border);background:var(--white);cursor:pointer;font-size:.88rem;font-weight:600;color:var(--gray);transition:all .2s}
.rtab.active{border-color:var(--primary);color:var(--primary);background:#f0f5ff}

/* SUMMARY */
.summary-panel{background:var(--white);border-radius:16px;box-shadow:var(--shadow);padding:24px;position:relative}
.summary-toolbar{display:flex;align-items:center;gap:8px;margin-bottom:16px;flex-wrap:wrap;padding-bottom:12px;border-bottom:1.5px solid var(--border)}
.toolbar-label{font-size:.8rem;font-weight:700;color:var(--gray);margin-right:2px}
.color-btn{width:28px;height:28px;border-radius:50%;border:3px solid transparent;cursor:pointer;transition:transform .15s}
.color-btn:hover,.color-btn.active{transform:scale(1.2);border-color:#333}
.tool-btn{padding:6px 12px;border-radius:7px;border:1.5px solid var(--border);background:var(--white);cursor:pointer;font-size:.82rem;font-weight:600;color:var(--gray);transition:all .2s}
.tool-btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}
.brush-size{width:68px;padding:4px 6px;border-radius:6px;border:1.5px solid var(--border);font-size:.82rem}
.divider{width:1px;background:var(--border);height:24px;margin:0 4px}
.summary-content{min-height:200px;line-height:1.9;font-size:.96rem;position:relative}
.summary-content strong{color:var(--primary-dark)}
.kw-tag{background:linear-gradient(90deg,#e8f0ff,#f0e8ff);color:var(--secondary);border-radius:20px;padding:4px 12px;font-size:.82rem;font-weight:700;display:inline-block;margin:3px}

/* CANVAS */
#drawCanvas{position:absolute;top:0;left:0;pointer-events:none;z-index:10;border-radius:12px}
#drawCanvas.drawing{pointer-events:all;cursor:crosshair}

/* KEYWORDS */
.keywords-bar{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:16px}
.section-title{font-size:.78rem;font-weight:700;color:var(--gray);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px}

/* MINDMAP */
.mindmap-panel{background:var(--white);border-radius:16px;box-shadow:var(--shadow);overflow:hidden;display:none}
.mindmap-toolbar{display:flex;gap:10px;padding:14px 20px;border-bottom:1.5px solid var(--border);align-items:center;flex-wrap:wrap}
.mindmap-toolbar span{font-size:.84rem;color:var(--gray)}
#mindmapSvg{width:100%;min-height:520px;display:block}

/* DOWNLOAD */
.download-bar{display:flex;gap:10px;margin-top:16px;flex-wrap:wrap}
.dl-btn{display:flex;align-items:center;gap:6px;padding:10px 18px;border-radius:9px;border:none;cursor:pointer;font-size:.88rem;font-weight:700;transition:all .2s}
.dl-summary{background:#f0f5ff;color:var(--primary)}
.dl-summary:hover{background:var(--primary);color:#fff}
.dl-mindmap{background:#f3f0ff;color:var(--secondary)}
.dl-mindmap:hover{background:var(--secondary);color:#fff}
.dl-both{background:linear-gradient(90deg,var(--primary),var(--secondary));color:#fff}
.dl-both:hover{opacity:.88}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:999;display:flex;align-items:center;justify-content:center;padding:20px}
.modal{background:var(--white);border-radius:20px;max-width:540px;width:100%;padding:36px;position:relative;animation:fadeIn .3s;max-height:90vh;overflow-y:auto}
@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.modal h2{font-size:1.5rem;font-weight:800;color:var(--primary);margin-bottom:6px}
.modal .subtitle{color:var(--gray);font-size:.9rem;margin-bottom:20px}
.guide-item{display:flex;gap:14px;margin-bottom:18px;align-items:flex-start}
.guide-icon{font-size:1.6rem;min-width:36px;text-align:center}
.guide-item h4{font-weight:700;margin-bottom:3px;font-size:.95rem}
.guide-item p{font-size:.83rem;color:var(--gray);line-height:1.5}
.notice-box{background:#fff8e8;border-left:4px solid var(--accent);padding:12px 16px;border-radius:8px;margin:16px 0;font-size:.84rem;line-height:1.7}
.modal-close{position:absolute;top:14px;right:18px;background:none;border:none;font-size:1.4rem;cursor:pointer;color:var(--gray)}

/* ERROR TOAST */
.toast{position:fixed;bottom:24px;right:24px;background:#1e2a3a;color:#fff;padding:12px 20px;border-radius:10px;font-size:.88rem;font-weight:600;z-index:9999;animation:slideUp .3s;display:none}
.toast.error{background:#ef4444}
.toast.success{background:#34d399;color:#1e2a3a}
@keyframes slideUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
</style>
</head>
<body>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- MODAL H∆Ø·ªöNG D·∫™N -->
<div class="modal-overlay" id="guideModal">
  <div class="modal">
    <button class="modal-close" onclick="closeGuide()">‚úï</button>
    <h2>üéâ Ch√†o m·ª´ng ƒë·∫øn DocSmart!</h2>
    <p class="subtitle">Tr·ª£ l√Ω t√≥m t·∫Øt t√†i li·ªáu th√¥ng minh ‚Äî mi·ªÖn ph√≠, kh√¥ng c·∫ßn ƒëƒÉng nh·∫≠p</p>
    <div class="guide-item">
      <div class="guide-icon">üìÑ</div>
      <div><h4>T·∫£i l√™n t√†i li·ªáu</h4><p>H·ªó tr·ª£ <b>PDF</b>, <b>Word (.docx)</b>, <b>·∫£nh JPG/PNG</b> ho·∫∑c d√°n vƒÉn b·∫£n tr·ª±c ti·∫øp v√†o √¥ text.</p></div>
    </div>
    <div class="guide-item">
      <div class="guide-icon">üé¨</div>
      <div><h4>Video & YouTube</h4><p>D√°n link YouTube ho·∫∑c t·∫£i video l√™n. Ch·ªâ h·ªó tr·ª£ ƒë·ªãnh d·∫°ng <b>MP4</b> v√† <b>WMV</b>, dung l∆∞·ª£ng t·ªëi ƒëa <b>50MB</b>.</p></div>
    </div>
    <div class="guide-item">
      <div class="guide-icon">üß†</div>
      <div><h4>T√≥m t·∫Øt & B·∫£n ƒë·ªì t∆∞ duy</h4><p>AI t·ª± ƒë·ªông t·∫°o b·∫£n t√≥m t·∫Øt c√≥ t·ª´ kh√≥a n·ªïi b·∫≠t v√† s∆° ƒë·ªì t∆∞ duy tr·ª±c quan, c√≥ th·ªÉ zoom v√† k√©o th·∫£.</p></div>
    </div>
    <div class="guide-item">
      <div class="guide-icon">üñäÔ∏è</div>
      <div><h4>Highlight & V·∫Ω t·ª± do</h4><p>D√πng b√∫t t√¥ m√†u ho·∫∑c b√∫t v·∫Ω l√™n b·∫£n t√≥m t·∫Øt. C√≥ 5 m√†u v√† 3 c·ª° b√∫t ƒë·ªÉ l·ª±a ch·ªçn.</p></div>
    </div>
    <div class="guide-item">
      <div class="guide-icon">‚¨áÔ∏è</div>
      <div><h4>T·∫£i xu·ªëng</h4><p>Xu·∫•t b·∫£n t√≥m t·∫Øt d·∫°ng <b>HTML</b> v√† b·∫£n ƒë·ªì t∆∞ duy d·∫°ng <b>SVG</b> v·ªÅ m√°y c·ªßa b·∫°n.</p></div>
    </div>
    <div class="notice-box">
      ‚ö†Ô∏è <b>L∆∞u √Ω quan tr·ªçng:</b><br>
      ‚Ä¢ Video ch·ªâ h·ªó tr·ª£ <b>MP4</b> v√† <b>WMV</b>, t·ªëi ƒëa <b>50MB</b><br>
      ‚Ä¢ V·ªõi YouTube, video c·∫ßn c√≥ <b>ph·ª• ƒë·ªÅ (subtitle)</b> ƒë·ªÉ ƒë·∫°t k·∫øt qu·∫£ t·ªët nh·∫•t<br>
      ‚Ä¢ File ·∫£nh s·∫Ω ƒë∆∞·ª£c tr√≠ch xu·∫•t vƒÉn b·∫£n t·ª± ƒë·ªông (OCR c∆° b·∫£n)
    </div>
    <button class="btn btn-primary analyze-btn" onclick="closeGuide()">‚úÖ B·∫Øt ƒë·∫ßu s·ª≠ d·ª•ng</button>
  </div>
</div>

<!-- HEADER -->
<header>
  <div class="logo">Doc<span>Smart</span></div>
  <div class="header-btns">
    <button class="btn btn-outline btn-sm" onclick="openGuide()">üìñ H∆∞·ªõng d·∫´n</button>
    <button class="btn btn-primary btn-sm" onclick="resetAll()">üîÑ L√†m m·ªõi</button>
  </div>
</header>

<!-- HERO -->
<div class="hero">
  <h1>T√≥m T·∫Øt T√†i Li·ªáu <span>Th√¥ng Minh</span></h1>
  <p>T·∫£i l√™n PDF, Word, ·∫£nh, video ho·∫∑c YouTube ‚Äî AI s·∫Ω t√≥m t·∫Øt, t·∫°o t·ª´ kh√≥a v√† b·∫£n ƒë·ªì t∆∞ duy ngay l·∫≠p t·ª©c.</p>
</div>

<div class="container">

  <!-- UPLOAD SECTION -->
  <div class="upload-section" id="uploadSection">
    <div class="upload-grid">
      <div class="upload-card" id="docCard" ondragover="drag(event,'docCard')" ondragleave="undrag('docCard')" ondrop="dropFile(event,'doc')">
        <input type="file" accept=".pdf,.doc,.docx,.txt" multiple onchange="addFiles(this.files,'doc')">
        <div class="upload-icon">üìÑ</div>
        <h3>PDF / Word / TXT</h3>
        <p>K√©o th·∫£ ho·∫∑c nh·∫•n ƒë·ªÉ ch·ªçn</p>
      </div>
      <div class="upload-card" id="imgCard" ondragover="drag(event,'imgCard')" ondragleave="undrag('imgCard')" ondrop="dropFile(event,'img')">
        <input type="file" accept="image/*" multiple onchange="addFiles(this.files,'img')">
        <div class="upload-icon">üñºÔ∏è</div>
        <h3>H√¨nh ·∫£nh (JPG / PNG)</h3>
        <p>K√©o th·∫£ ho·∫∑c nh·∫•n ƒë·ªÉ ch·ªçn</p>
      </div>
      <div class="upload-card" id="vidCard" ondragover="drag(event,'vidCard')" ondragleave="undrag('vidCard')" ondrop="dropFile(event,'vid')">
        <input type="file" accept=".mp4,.wmv" onchange="addFiles(this.files,'vid')">
        <div class="upload-icon">üé¨</div>
        <h3>Video (MP4 / WMV)</h3>
        <p>K√©o th·∫£ ho·∫∑c nh·∫•n ƒë·ªÉ ch·ªçn<br><small style="color:#aaa">T·ªëi ƒëa 50MB</small></p>
      </div>
      <div class="upload-card" style="cursor:default;background:#fafbff">
        <div class="upload-icon">‚ñ∂Ô∏è</div>
        <h3>YouTube Link</h3>
        <p>D√°n link v√†o √¥ b√™n d∆∞·ªõi</p>
      </div>
    </div>

    <!-- YouTube -->
    <div class="yt-row">
      <input type="url" id="ytUrl" placeholder="https://www.youtube.com/watch?v=..." />
      <button class="btn btn-outline" onclick="addYT()">+ Th√™m</button>
    </div>

    <!-- Paste text -->
    <p class="section-title">D√°n vƒÉn b·∫£n tr·ª±c ti·∫øp</p>
    <div class="text-area-wrap">
      <textarea id="pasteText" placeholder="D√°n n·ªôi dung vƒÉn b·∫£n t·∫°i ƒë√¢y..."></textarea>
      <span class="char-count" id="charCount">0 k√Ω t·ª±</span>
    </div>

    <!-- File list -->
    <div class="file-list" id="fileList"></div>

    <button class="analyze-btn" id="analyzeBtn" onclick="analyze()">‚ú® Ph√¢n t√≠ch & T√≥m t·∫Øt ngay</button>
  </div>

  <!-- LOADING -->
  <div class="loading" id="loading">
    <div class="spinner"></div>
    <p id="loadingMsg" style="font-weight:700;font-size:1rem">ƒêang x·ª≠ l√Ω t√†i li·ªáu...</p>
    <div class="loading-steps">
      <div class="loading-step" id="step1">üìÇ ƒê·ªçc & x·ª≠ l√Ω file</div>
      <div class="loading-step" id="step2">üîç Ph√¢n t√≠ch n·ªôi dung</div>
      <div class="loading-step" id="step3">‚úçÔ∏è T·∫°o b·∫£n t√≥m t·∫Øt</div>
      <div class="loading-step" id="step4">üè∑Ô∏è Tr√≠ch xu·∫•t t·ª´ kh√≥a</div>
      <div class="loading-step" id="step5">üß† X√¢y d·ª±ng b·∫£n ƒë·ªì t∆∞ duy</div>
    </div>
  </div>

  <!-- RESULT -->
  <div class="result-section" id="resultSection">
    <div class="result-tabs">
      <button class="rtab active" onclick="switchResult('summary',this)">üìù B·∫£n T√≥m T·∫Øt</button>
      <button class="rtab" onclick="switchResult('mindmap',this)">üß† B·∫£n ƒê·ªì T∆∞ Duy</button>
    </div>

    <!-- SUMMARY VIEW -->
    <div id="summaryView">
      <div class="summary-panel">
        <p class="section-title">T·ª´ kh√≥a tr·ªçng t√¢m</p>
        <div class="keywords-bar" id="keywordsBar"></div>

        <!-- Toolbar -->
        <div class="summary-toolbar">
          <span class="toolbar-label">üé®</span>
          <button class="color-btn active" style="background:#FFD700" data-color="#FFD700" onclick="setColor(this)" title="V√†ng"></button>
          <button class="color-btn" style="background:#4F8EF7" data-color="#4F8EF7" onclick="setColor(this)" title="Xanh d∆∞∆°ng"></button>
          <button class="color-btn" style="background:#EF4444" data-color="#EF4444" onclick="setColor(this)" title="ƒê·ªè"></button>
          <button class="color-btn" style="background:#F472B6" data-color="#F472B6" onclick="setColor(this)" title="H·ªìng"></button>
          <button class="color-btn" style="background:#22C55E" data-color="#22C55E" onclick="setColor(this)" title="Xanh l√°"></button>
          <div class="divider"></div>
          <button class="tool-btn" id="hlBtn" onclick="setTool('highlight')">üñä Highlight</button>
          <button class="tool-btn" id="drawBtn" onclick="setTool('draw')">‚úèÔ∏è B√∫t v·∫Ω</button>
          <button class="tool-btn active" id="cursorBtn" onclick="setTool('cursor')">üñ± Con tr·ªè</button>
          <select class="brush-size" id="brushSize" title="C·ª° b√∫t">
            <option value="8">Nh·ªè</option>
            <option value="16" selected>V·ª´a</option>
            <option value="28">L·ªõn</option>
          </select>
          <button class="tool-btn btn-sm" onclick="clearDrawing()" style="margin-left:auto;color:#ef4444;border-color:#fca5a5">üóë X√≥a n√©t</button>
        </div>

        <!-- Content + Canvas -->
        <div style="position:relative" id="contentWrap">
          <div class="summary-content" id="summaryContent"></div>
          <canvas id="drawCanvas"></canvas>
        </div>
      </div>

      <div class="download-bar">
        <button class="dl-btn dl-summary" onclick="downloadSummary()">‚¨áÔ∏è T·∫£i b·∫£n t√≥m t·∫Øt (HTML)</button>
        <button class="dl-btn dl-mindmap" onclick="downloadMindmap()">‚¨áÔ∏è T·∫£i b·∫£n ƒë·ªì t∆∞ duy (SVG)</button>
        <button class="dl-btn dl-both" onclick="downloadBoth()">‚¨áÔ∏è T·∫£i c·∫£ hai</button>
      </div>
    </div>

    <!-- MINDMAP VIEW -->
    <div class="mindmap-panel" id="mindmapView">
      <div class="mindmap-toolbar">
        <span>üîç Cu·ªôn ƒë·ªÉ zoom &nbsp;‚Ä¢&nbsp; K√©o ƒë·ªÉ di chuy·ªÉn</span>
        <button class="btn btn-outline btn-sm" onclick="resetZoom()" style="margin-left:auto">‚Ü∫ Reset Zoom</button>
        <button class="btn btn-primary btn-sm" onclick="downloadMindmap()">‚¨áÔ∏è T·∫£i SVG</button>
      </div>
      <svg id="mindmapSvg"></svg>
    </div>
  </div>
</div>

<script>
// ===================== CONFIG =====================
// Khi deploy l√™n Vercel, ƒë·ªïi th√†nh '/api/summarize'
// Khi ch·∫°y local/Claude preview, gi·ªØ nguy√™n ƒë·ªÉ d√πng fallback
const API_ENDPOINT = '/api/summarize';

// ===================== STATE =====================
let files = [], ytLinks = [];
let activeTool = 'cursor', activeColor = '#FFD700';
let isDrawing = false, lastX = 0, lastY = 0, ctx = null;
let summaryData = { summary: '', keywords: [], mindmap: null };
let mmZoom = null;

// ===================== MODAL =====================
function openGuide() { document.getElementById('guideModal').style.display = 'flex'; }
function closeGuide() { document.getElementById('guideModal').style.display = 'none'; }

// ===================== TOAST =====================
function toast(msg, type = 'error') {
  const el = document.getElementById('toast');
  el.textContent = msg; el.className = `toast ${type}`;
  el.style.display = 'block';
  setTimeout(() => { el.style.display = 'none'; }, 3000);
}

// ===================== DRAG & DROP =====================
function drag(e, id) { e.preventDefault(); document.getElementById(id).classList.add('dragover'); }
function undrag(id) { document.getElementById(id).classList.remove('dragover'); }
function dropFile(e, type) { e.preventDefault(); undrag(e.currentTarget.id); addFiles(e.dataTransfer.files, type); }

// ===================== FILE MANAGEMENT =====================
function addFiles(fl, type) {
  Array.from(fl).forEach(f => {
    if (type === 'vid' && !f.name.match(/\.(mp4|wmv)$/i)) { toast('‚ö†Ô∏è Ch·ªâ h·ªó tr·ª£ MP4 v√† WMV!'); return; }
    if (f.size > 50 * 1024 * 1024) { toast('‚ö†Ô∏è File v∆∞·ª£t qu√° 50MB!'); return; }
    files.push({ file: f, type });
  });
  renderFiles();
}

function addYT() {
  const url = document.getElementById('ytUrl').value.trim();
  if (!url.match(/youtube\.com|youtu\.be/)) { toast('‚ö†Ô∏è Link YouTube kh√¥ng h·ª£p l·ªá!'); return; }
  ytLinks.push(url);
  document.getElementById('ytUrl').value = '';
  renderFiles();
  toast('‚úÖ ƒê√£ th√™m link YouTube', 'success');
}

function removeItem(i, t) {
  if (t === 'yt') ytLinks.splice(i, 1); else files.splice(i, 1);
  renderFiles();
}

function renderFiles() {
  const el = document.getElementById('fileList');
  const icons = { doc: 'üìÑ', img: 'üñºÔ∏è', vid: 'üé¨' };
  let html = files.map((f, i) =>
    `<div class="file-item"><span>${icons[f.type]}</span><span class="fname">${f.file.name}</span>
     <small style="color:var(--gray);margin-right:4px">${(f.file.size/1024/1024).toFixed(1)}MB</small>
     <button class="fremove" onclick="removeItem(${i},'file')">‚úï</button></div>`
  ).join('');
  html += ytLinks.map((u, i) =>
    `<div class="file-item"><span>‚ñ∂Ô∏è</span><span class="fname">${u}</span>
     <button class="fremove" onclick="removeItem(${i},'yt')">‚úï</button></div>`
  ).join('');
  el.innerHTML = html;
}

document.getElementById('pasteText').addEventListener('input', function () {
  document.getElementById('charCount').textContent = this.value.length + ' k√Ω t·ª±';
});

// ===================== READ FILES =====================
async function readFileContent(f) {
  const name = f.file.name.toLowerCase();
  // TXT
  if (name.endsWith('.txt')) return f.file.text();
  // PDF
  if (name.endsWith('.pdf')) {
    try {
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
      const buf = await f.file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
      let text = '';
      for (let i = 1; i <= Math.min(pdf.numPages, 20); i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        text += content.items.map(s => s.str).join(' ') + '\n';
      }
      return text || `[PDF: ${f.file.name}]`;
    } catch { return `[PDF: ${f.file.name} ‚Äî kh√¥ng ƒë·ªçc ƒë∆∞·ª£c]`; }
  }
  // DOCX
  if (name.endsWith('.docx') || name.endsWith('.doc')) {
    try {
      const buf = await f.file.arrayBuffer();
      const result = await mammoth.extractRawText({ arrayBuffer: buf });
      return result.value || `[Word: ${f.file.name}]`;
    } catch { return `[Word: ${f.file.name} ‚Äî kh√¥ng ƒë·ªçc ƒë∆∞·ª£c]`; }
  }
  // Image ‚Äî m√¥ t·∫£ ƒë·ªÉ AI x·ª≠ l√Ω
  if (f.type === 'img') return `[H√¨nh ·∫£nh ƒë√≠nh k√®m: ${f.file.name}]`;
  // Video
  if (f.type === 'vid') return `[Video ƒë√≠nh k√®m: ${f.file.name}]`;
  return `[File: ${f.file.name}]`;
}

// ===================== LOADING STEPS =====================
let stepTimer = null;
function startSteps() {
  const steps = ['step1','step2','step3','step4','step5'];
  let cur = 0;
  steps.forEach(s => document.getElementById(s).className = 'loading-step');
  document.getElementById(steps[0]).classList.add('active');
  stepTimer = setInterval(() => {
    if (cur < steps.length - 1) {
      document.getElementById(steps[cur]).className = 'loading-step done';
      cur++;
      document.getElementById(steps[cur]).classList.add('active');
    }
  }, 1400);
}
function stopSteps() {
  clearInterval(stepTimer);
  ['step1','step2','step3','step4','step5'].forEach(s => {
    document.getElementById(s).className = 'loading-step done';
  });
}

// ===================== ANALYZE =====================
async function analyze() {
  const pasteText = document.getElementById('pasteText').value.trim();
  if (!files.length && !ytLinks.length && !pasteText) {
    toast('‚ö†Ô∏è Vui l√≤ng t·∫£i l√™n t√†i li·ªáu ho·∫∑c nh·∫≠p vƒÉn b·∫£n!'); return;
  }

  document.getElementById('uploadSection').style.display = 'none';
  document.getElementById('loading').style.display = 'flex';
  startSteps();

  // ƒê·ªçc n·ªôi dung c√°c file
  let parts = [];
  for (const f of files) {
    const content = await readFileContent(f);
    parts.push(`[${f.file.name}]\n${content}`);
  }
  ytLinks.forEach(u => parts.push(`[YouTube]: ${u}`));
  if (pasteText) parts.push(`[VƒÉn b·∫£n]\n${pasteText}`);

  const userContent = parts.join('\n\n---\n\n').slice(0, 8000);

  const prompt = `B·∫°n l√† tr·ª£ l√Ω t√≥m t·∫Øt t√†i li·ªáu th√¥ng minh. Ng∆∞·ªùi d√πng ƒë√£ cung c·∫•p n·ªôi dung sau:\n\n${userContent}\n\nH√£y th·ª±c hi·ªán:\n1. T√≥m t·∫Øt c√°c √Ω ch√≠nh quan tr·ªçng (250-450 t·ª´, chia th√†nh 3-4 ƒëo·∫°n r√µ r√†ng c√≥ ti√™u ƒë·ªÅ in ƒë·∫≠m b·∫±ng th·∫ª <strong>)\n2. Li·ªát k√™ 7-10 t·ª´ kh√≥a tr·ªçng t√¢m ng·∫Øn g·ªçn\n3. T·∫°o c·∫•u tr√∫c b·∫£n ƒë·ªì t∆∞ duy ph√¢n c·∫•p\n\nTr·∫£ v·ªÅ JSON thu·∫ßn (kh√¥ng markdown backtick) ƒë√∫ng format:\n{"summary":"<strong>üìå Ti√™u ƒë·ªÅ 1</strong><br>n·ªôi dung...<br><br><strong>üéØ Ti√™u ƒë·ªÅ 2</strong><br>n·ªôi dung...","keywords":["kw1","kw2","kw3"],"mindmap":{"title":"Ch·ªß ƒë·ªÅ ch√≠nh","children":[{"title":"Nh√°nh 1","children":[{"title":"√ù 1.1"},{"title":"√ù 1.2"}]},{"title":"Nh√°nh 2","children":[{"title":"√ù 2.1"},{"title":"√ù 2.2"}]},{"title":"Nh√°nh 3","children":[{"title":"√ù 3.1"}]}]}}`;

  try {
    const resp = await fetch(API_ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt })
    });
    if (!resp.ok) throw new Error('API error ' + resp.status);
    const data = await resp.json();
    const raw = (data.content || []).map(i => i.text || '').join('');
    const clean = raw.replace(/```json|```/g, '').trim();
    summaryData = JSON.parse(clean);
  } catch (e) {
    console.warn('API failed, using demo data:', e.message);
    summaryData = {
      summary: `<strong>üìå T·ªïng quan n·ªôi dung</strong><br>T√†i li·ªáu tr√¨nh b√†y c√°c n·ªôi dung quan tr·ªçng li√™n quan ƒë·∫øn ch·ªß ƒë·ªÅ ƒë∆∞·ª£c cung c·∫•p. C√°c th√¥ng tin ƒë∆∞·ª£c t·ªï ch·ª©c m·ªôt c√°ch h·ªá th·ªëng, gi√∫p ng∆∞·ªùi ƒë·ªçc d·ªÖ d√†ng n·∫Øm b·∫Øt to√†n b·ªô √Ω nghƒ©a.<br><br><strong>üéØ C√°c ƒëi·ªÉm ch√≠nh</strong><br>N·ªôi dung bao g·ªìm vi·ªác ph√¢n t√≠ch, ƒë√°nh gi√° v√† t·ªïng h·ª£p th√¥ng tin t·ª´ nhi·ªÅu g√≥c ƒë·ªô kh√°c nhau. Ng∆∞·ªùi ƒë·ªçc c·∫ßn n·∫Øm b·∫Øt c√°c lu·∫≠n ƒëi·ªÉm c·ªët l√µi ƒë·ªÉ hi·ªÉu s√¢u h∆°n v·ªÅ ch·ªß ƒë·ªÅ.<br><br><strong>üí° ·ª®ng d·ª•ng th·ª±c ti·ªÖn</strong><br>T√†i li·ªáu nh·∫•n m·∫°nh t·∫ßm quan tr·ªçng c·ªßa vi·ªác √°p d·ª•ng ki·∫øn th·ª©c v√†o th·ª±c ti·ªÖn. Vi·ªác hi·ªÉu r√µ c√°c kh√°i ni·ªám n·ªÅn t·∫£ng s·∫Ω gi√∫p gi·∫£i quy·∫øt c√°c b√†i to√°n ph·ª©c t·∫°p h∆°n.<br><br><strong>üìù K·∫øt lu·∫≠n</strong><br>C·∫ßn li√™n t·ª•c c·∫≠p nh·∫≠t v√† m·ªü r·ªông ki·∫øn th·ª©c d·ª±a tr√™n n·ªÅn t·∫£ng ƒë√£ h·ªçc, k·∫øt h·ª£p v·ªõi th·ª±c h√†nh ƒë·ªÉ ƒë·∫°t hi·ªáu qu·∫£ t·ªët nh·∫•t.`,
      keywords: ['T√≥m t·∫Øt', 'Ph√¢n t√≠ch', 'T√†i li·ªáu', 'Ki·∫øn th·ª©c', 'Th·ª±c ti·ªÖn', '·ª®ng d·ª•ng', 'H·ªçc t·∫≠p'],
      mindmap: {
        title: 'Ch·ªß ƒê·ªÅ Ch√≠nh', children: [
          { title: 'T·ªïng quan', children: [{ title: 'B·ªëi c·∫£nh' }, { title: 'M·ª•c ti√™u' }] },
          { title: 'N·ªôi dung ch√≠nh', children: [{ title: 'ƒêi·ªÉm 1' }, { title: 'ƒêi·ªÉm 2' }, { title: 'ƒêi·ªÉm 3' }] },
          { title: '·ª®ng d·ª•ng', children: [{ title: 'Th·ª±c ti·ªÖn' }, { title: 'M·ªü r·ªông' }] },
          { title: 'K·∫øt lu·∫≠n', children: [{ title: 'T·ªïng k·∫øt' }] }
        ]
      }
    };
  }

  stopSteps();
  document.getElementById('loading').style.display = 'none';
  showResults();
}

// ===================== SHOW RESULTS =====================
function showResults() {
  document.getElementById('resultSection').style.display = 'block';

  // Keywords
  document.getElementById('keywordsBar').innerHTML =
    summaryData.keywords.map(k => `<span class="kw-tag">${k}</span>`).join('');

  // Summary
  document.getElementById('summaryContent').innerHTML = summaryData.summary;

  // Mindmap
  drawMindmap(summaryData.mindmap);

  // Canvas
  setTimeout(initCanvas, 100);

  window.scrollTo({ top: document.getElementById('resultSection').offsetTop - 80, behavior: 'smooth' });
}

// ===================== RESULT TABS =====================
function switchResult(view, btn) {
  document.querySelectorAll('.rtab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('summaryView').style.display = view === 'summary' ? 'block' : 'none';
  document.getElementById('mindmapView').style.display = view === 'mindmap' ? 'block' : 'none';
}

// ===================== CANVAS =====================
function initCanvas() {
  const wrap = document.getElementById('contentWrap');
  const canvas = document.getElementById('drawCanvas');
  canvas.width = wrap.offsetWidth;
  canvas.height = wrap.offsetHeight || 300;
  canvas.style.width = wrap.offsetWidth + 'px';
  canvas.style.height = canvas.height + 'px';
  canvas.style.top = '0'; canvas.style.left = '0';
  ctx = canvas.getContext('2d');

  // Mouse
  canvas.addEventListener('mousedown', e => startDraw(e.offsetX, e.offsetY));
  canvas.addEventListener('mousemove', e => draw(e.offsetX, e.offsetY));
  canvas.addEventListener('mouseup', stopDraw);
  canvas.addEventListener('mouseleave', stopDraw);

  // Touch
  canvas.addEventListener('touchstart', e => {
    e.preventDefault();
    const r = canvas.getBoundingClientRect(), t = e.touches[0];
    startDraw(t.clientX - r.left, t.clientY - r.top);
  }, { passive: false });
  canvas.addEventListener('touchmove', e => {
    e.preventDefault();
    const r = canvas.getBoundingClientRect(), t = e.touches[0];
    draw(t.clientX - r.left, t.clientY - r.top);
  }, { passive: false });
  canvas.addEventListener('touchend', stopDraw);
}

function setTool(t) {
  activeTool = t;
  ['hlBtn','drawBtn','cursorBtn'].forEach(id => document.getElementById(id).classList.remove('active'));
  const map = { highlight: 'hlBtn', draw: 'drawBtn', cursor: 'cursorBtn' };
  document.getElementById(map[t]).classList.add('active');
  const canvas = document.getElementById('drawCanvas');
  if (t === 'cursor') canvas.classList.remove('drawing');
  else canvas.classList.add('drawing');
}

function setColor(btn) {
  activeColor = btn.dataset.color;
  document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

function hexToRgba(hex, a) {
  const r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
  return `rgba(${r},${g},${b},${a})`;
}

function startDraw(x, y) {
  if (activeTool === 'cursor') return;
  isDrawing = true; lastX = x; lastY = y;
}

function draw(x, y) {
  if (!isDrawing || !ctx || activeTool === 'cursor') return;
  const size = parseInt(document.getElementById('brushSize').value);
  ctx.beginPath();
  if (activeTool === 'highlight') {
    ctx.globalCompositeOperation = 'source-over';
    ctx.strokeStyle = hexToRgba(activeColor, 0.38);
    ctx.lineWidth = size * 2;
    ctx.lineCap = 'square';
  } else {
    ctx.globalCompositeOperation = 'source-over';
    ctx.strokeStyle = hexToRgba(activeColor, 0.92);
    ctx.lineWidth = size / 2.5;
    ctx.lineCap = 'round';
  }
  ctx.moveTo(lastX, lastY); ctx.lineTo(x, y); ctx.stroke();
  lastX = x; lastY = y;
}

function stopDraw() { isDrawing = false; }

function clearDrawing() {
  if (ctx) ctx.clearRect(0, 0, document.getElementById('drawCanvas').width, document.getElementById('drawCanvas').height);
}

// ===================== MINDMAP =====================
function drawMindmap(data) {
  const svg = d3.select('#mindmapSvg');
  svg.selectAll('*').remove();
  const svgEl = document.getElementById('mindmapSvg');
  const W = svgEl.clientWidth || 900, H = 540;
  svg.attr('viewBox', `0 0 ${W} ${H}`).attr('height', H);

  // Defs gradient + shadow
  const defs = svg.append('defs');
  const grad = defs.append('linearGradient').attr('id', 'rootGrad').attr('x1','0%').attr('x2','100%');
  grad.append('stop').attr('offset','0%').attr('stop-color','#4F8EF7');
  grad.append('stop').attr('offset','100%').attr('stop-color','#7C5CBF');
  const filt = defs.append('filter').attr('id','shadow').attr('x','-20%').attr('y','-20%').attr('width','140%').attr('height','140%');
  filt.append('feDropShadow').attr('dx','0').attr('dy','2').attr('stdDeviation','3').attr('flood-opacity','0.12');

  const g = svg.append('g');
  mmZoom = d3.zoom().scaleExtent([0.25, 3]).on('zoom', e => g.attr('transform', e.transform));
  svg.call(mmZoom);

  const palette = ['#4F8EF7','#7C5CBF','#F7A84F','#34d399','#F472B6','#EF4444','#06b6d4'];

  const root = d3.hierarchy(data);
  const tree = d3.tree().size([H - 80, W - 220]);
  tree(root);

  // Links
  g.selectAll('.link').data(root.links()).enter().append('path')
    .attr('fill', 'none')
    .attr('stroke', d => palette[(d.target.depth - 1) % palette.length] + '55')
    .attr('stroke-width', d => d.target.depth === 1 ? 2.5 : 1.5)
    .attr('d', d3.linkHorizontal().x(n => n.y + 90).y(n => n.x + 40));

  // Nodes
  const node = g.selectAll('.node').data(root.descendants()).enter().append('g')
    .attr('transform', d => `translate(${d.y + 90},${d.x + 40})`);

  // Box
  node.append('rect')
    .attr('rx', 10).attr('ry', 10)
    .attr('x', d => d.depth === 0 ? -70 : -58)
    .attr('y', -18)
    .attr('width', d => d.depth === 0 ? 140 : 116)
    .attr('height', 36)
    .attr('fill', d => {
      if (d.depth === 0) return 'url(#rootGrad)';
      const c = palette[(d.depth - 1) % palette.length];
      return d.depth === 1 ? c : c + '22';
    })
    .attr('stroke', d => d.depth === 0 ? 'none' : palette[(d.depth - 1) % palette.length])
    .attr('stroke-width', d => d.depth === 1 ? 2 : 1.5)
    .attr('filter', 'url(#shadow)');

  // Text
  node.append('text')
    .attr('text-anchor', 'middle').attr('dy', '0.35em')
    .attr('font-size', d => d.depth === 0 ? 13 : d.depth === 1 ? 11.5 : 10.5)
    .attr('font-weight', d => d.depth <= 1 ? 700 : 500)
    .attr('fill', d => d.depth <= 1 ? '#fff' : '#1e2a3a')
    .text(d => {
      const t = d.data.title || '';
      return t.length > 15 ? t.slice(0, 14) + '‚Ä¶' : t;
    });
}

function resetZoom() {
  if (mmZoom) d3.select('#mindmapSvg').transition().duration(400).call(mmZoom.transform, d3.zoomIdentity);
}

// ===================== DOWNLOAD =====================
function downloadSummary() {
  const kwHtml = Array.from(document.querySelectorAll('.kw-tag'))
    .map(k => `<span style="background:#e8f0ff;color:#7C5CBF;border-radius:20px;padding:3px 12px;font-size:13px;font-weight:700;margin:3px;display:inline-block">${k.textContent}</span>`).join('');
  const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>B·∫£n T√≥m T·∫Øt - DocSmart</title>
<style>body{font-family:'Segoe UI',sans-serif;padding:40px;max-width:800px;margin:auto;color:#1e2a3a;line-height:1.9}
h1{color:#4F8EF7;font-size:1.8rem;margin-bottom:6px}
.subtitle{color:#6b7280;margin-bottom:20px;font-size:.95rem}
hr{border:none;border-top:2px solid #eee;margin:18px 0}
.kw-wrap{margin-bottom:20px} strong{color:#3a72d4}
footer{color:#aaa;font-size:.78rem;text-align:right;margin-top:40px;padding-top:12px;border-top:1px solid #eee}
</style></head><body>
<h1>üìÑ B·∫£n T√≥m T·∫Øt</h1>
<p class="subtitle">T·∫°o b·ªüi <b>DocSmart</b> ‚Äî ${new Date().toLocaleDateString('vi-VN')}</p>
<hr><div class="kw-wrap"><b>üè∑Ô∏è T·ª´ kh√≥a tr·ªçng t√¢m:</b><br>${kwHtml}</div><hr>
<div>${document.getElementById('summaryContent').innerHTML}</div>
<div class="footer">DocSmart ¬© ${new Date().getFullYear()}</div>
</body></html>`;
  const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'tom-tat-docsmart.html';
  a.click(); URL.revokeObjectURL(a.href);
  toast('‚úÖ ƒê√£ t·∫£i b·∫£n t√≥m t·∫Øt!', 'success');
}

function downloadMindmap() {
  const svg = document.getElementById('mindmapSvg');
  const blob = new Blob([svg.outerHTML], { type: 'image/svg+xml' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'mindmap-docsmart.svg';
  a.click(); URL.revokeObjectURL(a.href);
  toast('‚úÖ ƒê√£ t·∫£i b·∫£n ƒë·ªì t∆∞ duy!', 'success');
}

function downloadBoth() {
  downloadSummary();
  setTimeout(downloadMindmap, 600);
}

// ===================== RESET =====================
function resetAll() {
  files = []; ytLinks = [];
  document.getElementById('pasteText').value = '';
  document.getElementById('charCount').textContent = '0 k√Ω t·ª±';
  document.getElementById('fileList').innerHTML = '';
  document.getElementById('uploadSection').style.display = 'block';
  document.getElementById('loading').style.display = 'none';
  document.getElementById('resultSection').style.display = 'none';
  if (ctx) ctx.clearRect(0, 0, 9999, 9999);
}
</script>
</body>
</html>
